<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Laika 0.18.1 + Helium Theme" />
  <title>Metrics DSL</title>
  
  
  <meta name="description" content="docs"/>
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="/img/icon-150x150.png"/>
  
  <link rel="icon" sizes="192x192" type="image/png" href="/img/icon-300x300.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">
  
  <link rel="stylesheet" type="text/css" href="../helium/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="../helium/laika-helium.css" />
    <link rel="stylesheet" type="text/css" href="../css/permutive.css" />
    <link rel="stylesheet" type="text/css" href="../site/styles.css" />
  <script src="../helium/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

<body>

<div id="bg"></div>

<header id="top-bar">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika" title="Navigation">&#xefa2;</i>
    </a>
    
  </div>

  <a class="image-link" href="https://permutive.com"><img src="../img/symbol.svg"></a>

  <span class="row links"><a class="icon-link svg-link" href="https://oss.sonatype.org/service/local/repositories/snapshots/archive/com/permutive/prometheus4cats-docs_2.13/0.0-2a63fc0-SNAPSHOT/prometheus4cats-docs_2.13-0.0-2a63fc0-SNAPSHOT-javadoc.jar/!/index.html"><span title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a><a class="icon-link svg-link" href="https://github.com/permutive-engineering/prometheus4cats"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a></span>

</header>

<nav id="sidebar">

  <div class="row">
    <a class="icon-link svg-link" href="https://oss.sonatype.org/service/local/repositories/snapshots/archive/com/permutive/prometheus4cats-docs_2.13/0.0-2a63fc0-SNAPSHOT/prometheus4cats-docs_2.13-0.0-2a63fc0-SNAPSHOT-javadoc.jar/!/index.html"><span title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a><a class="icon-link svg-link" href="https://github.com/permutive-engineering/prometheus4cats"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
  </div>

  <ul class="nav-list">
    <li class="level1"><a href="../index.html">Prometheus4Cats</a></li>
    <li class="level1 nav-header">design</li>
    <li class="level2"><a href="../design/design.html">Design</a></li>
    <li class="level1 nav-header">implementations</li>
    <li class="level2"><a href="../implementations/java.html">Java Registry</a></li>
    <li class="level1 nav-header">interface</li>
    <li class="level2"><a href="callback-registry.html">Callback Registry</a></li>
    <li class="level2 active"><a href="#">Metrics DSL</a></li>
    <li class="level2"><a href="metric-factory.html">Metric Factory</a></li>
    <li class="level2"><a href="metric-registry.html">Metric Registry</a></li>
    <li class="level1 nav-header">metrics</li>
    <li class="level2"><a href="../metrics/derived-metric-types.html">Derived Metric Types</a></li>
    <li class="level2"><a href="../metrics/primitive-metric-types.html">Primitive Metric Types</a></li>
  </ul>

  <ul class="nav-list">
    <li class="level1 nav-header">Related Projects</li>
    
    <li class="level2"><a href="https://typelevel.org/cats/">cats</a></li>
    
    <li class="level2"><a href="https://typelevel.org/cats-effect/">cats-effect</a></li>
    
    <li class="level2"><a href="https://github.com/davenverse/epimetheus">epimetheus</a></li>
    
  </ul>

</nav>

<div id="container">

  <nav id="page-nav">
    <p class="header"><a href="#">Metrics DSL</a></p>

    <ul class="nav-list">
      <li class="level1"><a href="#refined-types">Refined Types</a></li>
      <li class="level1"><a href="#choosing-a-primitive-metric">Choosing a Primitive Metric</a></li>
      <li class="level1"><a href="#specifying-the-underlying-number-format">Specifying the Underlying Number Format</a></li>
      <li class="level1"><a href="#defining-the-help-string">Defining the Help String</a></li>
      <li class="level1"><a href="#building-a-simple-metric">Building a Simple Metric</a></li>
      <li class="level1"><a href="#adding-labels">Adding Labels</a></li>
      <li class="level2"><a href="#adding-individual-labels">Adding Individual Labels</a></li>
      <li class="level2"><a href="#compile-time-checked-sequence-of-labels">Compile-Time Checked Sequence of Labels</a></li>
      <li class="level2"><a href="#unchecked-sequence-of-labels">Unchecked Sequence of Labels</a></li>
      <li class="level1"><a href="#contramapping-a-metric-type">Contramapping a Metric Type</a></li>
      <li class="level2"><a href="#simple-metric">Simple Metric</a></li>
      <li class="level2"><a href="#labelled-metric">Labelled Metric</a></li>
      <li class="level1"><a href="#contramapping-metric-labels">Contramapping Metric Labels</a></li>
      <li class="level1"><a href="#metric-callbacks">Metric Callbacks</a></li>
      <li class="level2"><a href="#metric-collection">Metric Collection</a></li>
    </ul>

    <p class="footer"></p>
  </nav>

  <main class="content">

    <h1 id="metrics-dsl" class="title">Metrics DSL</h1>
    <p>The metrics DSL provides a fluent API for constructing <a href="../metrics/primitive-metric-types.html">primitive</a> and <a href="../metrics/derived-metric-types.html">derived</a> metrics from a <a href="metric-factory.html"><code>MetricFactory</code></a>. It
    is designed to provide <em>some</em> compile time safety when recording metrics in terms of matching label values to label
    names. It <strong>does not</strong> check that a metric is unique - this is only checked at runtime, the uniqueness of a
    metric (name &amp; labels combination) depends on the <a href="metric-factory.html"><code>MetricFactory</code></a> implementation.</p>
    <p>The examples in this section assume you have imported the following and have created a <a href="metric-factory.html"><code>MetricFactory</code></a>:</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">prometheus4cats</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">val</span><span> </span><span class="identifier">factory</span><span>: </span><span class="type-name">MetricFactory</span><span>.</span><span class="type-name">WithCallbacks</span><span>[</span><span class="type-name">IO</span><span>] = </span><span class="type-name">MetricFactory</span><span>.</span><span class="identifier">builder</span><span>.</span><span class="identifier">noop</span><span>[</span><span class="type-name">IO</span><span>]
</span><span class="comment">// factory: MetricFactory.WithCallbacks[IO] = prometheus4cats.MetricFactory$WithCallbacks$$anon$35@d91e0c</span></code></pre>
    
    <h3 id="refined-types" class="section">Refined Types<a class="anchor-link right" href="#refined-types"><i class="icofont-laika">&#xef71;</i></a></h3>
    <p>Value classes exist for metric and label names that are refined at compile time from string literals. It is also
    possible to refine at runtime, where the result is returned in an <code>Either</code>.</p>
    <p>The value classes used by the DSL are as follows:</p>
    <ul>
      <li><code>Counter.Name</code></li>
      <li><code>Gauge.Name</code></li>
      <li><code>Histogram.Name</code></li>
      <li><code>Summary.Name</code></li>
      <li><code>Info.Name</code></li>
      <li><code>Label.Name</code></li>
      <li><code>Metric.Help</code></li>
    </ul>
    <p>When used in the DSL with string literals the value classes are implicitly resolved, so there is no need to wrap every
    value.</p>
    
    <h3 id="choosing-a-primitive-metric" class="section">Choosing a Primitive Metric<a class="anchor-link right" href="#choosing-a-primitive-metric"><i class="icofont-laika">&#xef71;</i></a></h3>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">factory</span><span>.</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
</span><span class="identifier">factory</span><span>.</span><span class="identifier">gauge</span><span>(</span><span class="string-literal">&quot;gauge&quot;</span><span>)
</span><span class="identifier">factory</span><span>.</span><span class="identifier">histogram</span><span>(</span><span class="string-literal">&quot;histogram&quot;</span><span>)
</span><span class="identifier">factory</span><span>.</span><span class="identifier">summary</span><span>(</span><span class="string-literal">&quot;summary&quot;</span><span>)
</span><span class="identifier">factory</span><span>.</span><span class="identifier">info</span><span>(</span><span class="string-literal">&quot;info_info&quot;</span><span>)</span></code></pre>
    
    <h3 id="specifying-the-underlying-number-format" class="section">Specifying the Underlying Number Format<a class="anchor-link right" href="#specifying-the-underlying-number-format"><i class="icofont-laika">&#xef71;</i></a></h3>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">factory</span><span>.</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>).</span><span class="identifier">ofDouble</span><span>
</span><span class="identifier">factory</span><span>.</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>).</span><span class="identifier">ofLong</span></code></pre>
    
    <h3 id="defining-the-help-string" class="section">Defining the Help String<a class="anchor-link right" href="#defining-the-help-string"><i class="icofont-laika">&#xef71;</i></a></h3>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">factory</span><span>.</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>).</span><span class="identifier">ofDouble</span><span>.</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)</span></code></pre>
    
    <h3 id="building-a-simple-metric" class="section">Building a Simple Metric<a class="anchor-link right" href="#building-a-simple-metric"><i class="icofont-laika">&#xef71;</i></a></h3>
    <p>Once you have specified all the parameters with which you want to create your metric you can call the <code>build</code> method.
    This will return a <code>cats.effect.Resource</code> of your desired metric, which will de-register the metric from the underlying
    <a href="metric-registry.html"><code>MetricRegistry</code></a> or <a href="callback-registry.html"><code>CallbackRegistry</code></a> upon finalization.</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">simpleCounter</span><span> = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)

</span><span class="identifier">simpleCounter</span><span>.</span><span class="identifier">build</span></code></pre>
    <p>While not recommended, it is possible to build the metric without a <code>cats.effect.Resource</code>, which will not de-register
    from the underlying <a href="metric-registry.html"><code>MetricRegistry</code></a>:</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">simpleCounter</span><span>.</span><span class="identifier">unsafeBuild</span></code></pre>
    
    <h3 id="adding-labels" class="section">Adding Labels<a class="anchor-link right" href="#adding-labels"><i class="icofont-laika">&#xef71;</i></a></h3>
    
    <h4 id="adding-individual-labels" class="section">Adding Individual Labels<a class="anchor-link right" href="#adding-individual-labels"><i class="icofont-laika">&#xef71;</i></a></h4>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">MyClass</span><span>(</span><span class="identifier">value</span><span>: </span><span class="type-name">String</span><span>)

</span><span class="keyword">val</span><span> </span><span class="identifier">tupleLabelledCounter</span><span> = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;this_uses_show&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">MyClass</span><span>](</span><span class="string-literal">&quot;this_doesnt_use_show&quot;</span><span>, </span><span class="identifier">_</span><span>.</span><span class="identifier">value</span><span>)

</span><span class="identifier">tupleLabelledCounter</span><span>.</span><span class="identifier">build</span><span>.</span><span class="identifier">evalMap</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">inc</span><span>(</span><span class="number-literal">2.0</span><span>, (</span><span class="string-literal">&quot;label_value&quot;</span><span>, </span><span class="type-name">MyClass</span><span>(</span><span class="string-literal">&quot;label_value&quot;</span><span>))))</span></code></pre>
    
    <h4 id="compile-time-checked-sequence-of-labels" class="section">Compile-Time Checked Sequence of Labels<a class="anchor-link right" href="#compile-time-checked-sequence-of-labels"><i class="icofont-laika">&#xef71;</i></a></h4>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">MyMultiClass</span><span>(</span><span class="identifier">value1</span><span>: </span><span class="type-name">String</span><span>, </span><span class="identifier">value2</span><span>: </span><span class="type-name">Int</span><span>)

</span><span class="keyword">val</span><span> </span><span class="identifier">classLabelledCounter</span><span> = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">labels</span><span>(</span><span class="type-name">Sized</span><span>(</span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label1&quot;</span><span>), </span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label2&quot;</span><span>)))((</span><span class="identifier">x</span><span>: </span><span class="type-name">MyMultiClass</span><span>) =&gt;
    </span><span class="type-name">Sized</span><span>(</span><span class="identifier">x</span><span>.</span><span class="identifier">value1</span><span>, </span><span class="identifier">x</span><span>.</span><span class="identifier">value2</span><span>.</span><span class="identifier">toString</span><span>)
  )

</span><span class="identifier">classLabelledCounter</span><span>.</span><span class="identifier">build</span><span>.</span><span class="identifier">evalMap</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">inc</span><span>(</span><span class="number-literal">2.0</span><span>, </span><span class="type-name">MyMultiClass</span><span>(</span><span class="string-literal">&quot;label_value&quot;</span><span>, </span><span class="number-literal">42</span><span>)))</span></code></pre>
    
    <h4 id="unchecked-sequence-of-labels" class="section">Unchecked Sequence of Labels<a class="anchor-link right" href="#unchecked-sequence-of-labels"><i class="icofont-laika">&#xef71;</i></a></h4>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">unsafeLabelledCounter</span><span> = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">unsafeLabels</span><span>(</span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label1&quot;</span><span>), </span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label2&quot;</span><span>))

</span><span class="keyword">val</span><span> </span><span class="identifier">labels</span><span> = </span><span class="type-name">Map</span><span>(</span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label1&quot;</span><span>) -&gt; </span><span class="string-literal">&quot;label1_value&quot;</span><span>, </span><span class="type-name">Label</span><span>.</span><span class="type-name">Name</span><span>(</span><span class="string-literal">&quot;label2&quot;</span><span>) -&gt; </span><span class="string-literal">&quot;label1_value&quot;</span><span>)
</span><span class="identifier">unsafeLabelledCounter</span><span>.</span><span class="identifier">build</span><span>.</span><span class="identifier">evalMap</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">inc</span><span>(</span><span class="number-literal">3.0</span><span>, </span><span class="identifier">labels</span><span>))</span></code></pre>
    
    <h3 id="contramapping-a-metric-type" class="section">Contramapping a Metric Type<a class="anchor-link right" href="#contramapping-a-metric-type"><i class="icofont-laika">&#xef71;</i></a></h3>
    
    <h4 id="simple-metric" class="section">Simple Metric<a class="anchor-link right" href="#simple-metric"><i class="icofont-laika">&#xef71;</i></a></h4>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">intCounter</span><span>: </span><span class="type-name">Resource</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Counter</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Int</span><span>]] = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofLong</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">contramap</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="identifier">_</span><span>.</span><span class="identifier">toLong</span><span>)
  .</span><span class="identifier">build</span></code></pre>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">shortCounter</span><span>: </span><span class="type-name">Resource</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Counter</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Short</span><span>]] = </span><span class="identifier">intCounter</span><span>.</span><span class="identifier">map</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">contramap</span><span>[</span><span class="type-name">Short</span><span>](</span><span class="identifier">_</span><span>.</span><span class="identifier">toInt</span><span>))</span></code></pre>
    
    <h4 id="labelled-metric" class="section">Labelled Metric<a class="anchor-link right" href="#labelled-metric"><i class="icofont-laika">&#xef71;</i></a></h4>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">intLabelledCounter</span><span>: </span><span class="type-name">Resource</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Counter</span><span>.</span><span class="type-name">Labelled</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Int</span><span>, (</span><span class="type-name">String</span><span>, </span><span class="type-name">Int</span><span>)]] = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofLong</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;string_label&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="string-literal">&quot;int_label&quot;</span><span>)
  .</span><span class="identifier">contramap</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="identifier">_</span><span>.</span><span class="identifier">toLong</span><span>)
  .</span><span class="identifier">build</span></code></pre>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">shortLabelledCounter</span><span>: </span><span class="type-name">Resource</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Counter</span><span>.</span><span class="type-name">Labelled</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Short</span><span>, (</span><span class="type-name">String</span><span>, </span><span class="type-name">Int</span><span>)]] =
  </span><span class="identifier">intLabelledCounter</span><span>.</span><span class="identifier">map</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">contramap</span><span>[</span><span class="type-name">Short</span><span>](</span><span class="identifier">_</span><span>.</span><span class="identifier">toInt</span><span>))</span></code></pre>
    
    <h3 id="contramapping-metric-labels" class="section">Contramapping Metric Labels<a class="anchor-link right" href="#contramapping-metric-labels"><i class="icofont-laika">&#xef71;</i></a></h3>
    <p>This can work as a nice alternative to
    <a href="#compile-time-checked-sequence-of-labels">providing a compile-time checked sequence of labels</a></p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">LabelsClass</span><span>(</span><span class="identifier">string</span><span>: </span><span class="type-name">String</span><span>, </span><span class="identifier">int</span><span>: </span><span class="type-name">Int</span><span>)

</span><span class="keyword">val</span><span> </span><span class="identifier">updatedLabelsCounter</span><span>: </span><span class="type-name">Resource</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Counter</span><span>.</span><span class="type-name">Labelled</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Long</span><span>, </span><span class="type-name">LabelsClass</span><span>]] = </span><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofLong</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;string_label&quot;</span><span>)
  .</span><span class="identifier">label</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="string-literal">&quot;int_label&quot;</span><span>)
  .</span><span class="identifier">contramapLabels</span><span>[</span><span class="type-name">LabelsClass</span><span>](</span><span class="identifier">c</span><span> =&gt; (</span><span class="identifier">c</span><span>.</span><span class="identifier">string</span><span>, </span><span class="identifier">c</span><span>.</span><span class="identifier">int</span><span>))
  .</span><span class="identifier">build</span></code></pre>
    
    <h3 id="metric-callbacks" class="section">Metric Callbacks<a class="anchor-link right" href="#metric-callbacks"><i class="icofont-laika">&#xef71;</i></a></h3>
    <p>The callback DSL is only available with the <code>MetricFactory.WithCallbacks</code> implementation of <a href="metric-factory.html"><code>MetricFactory</code></a>.</p>
    <p>Callbacks are useful when you have some runtime source of a metric value, like a JMX MBean, which will be loaded when
    the current values for each metric is inspected for export to Prometheus.</p>
    <p><strong>Callbacks are both extremely powerful and dangerous, so should be used with care</strong>. Callbacks are assumed to be
    side-effecting in that each execution of the callback may yield a different underlying value, this also means that
    the operation could take a long time to complete if there is I/O involved (this is strongly discouraged). Therefore,
    implementations of <a href="callback-registry.html"><code>CallbackRegistry</code></a> may include a timeout.</p>
    <blockquote>
      <p>ℹ️ Some general guidance on callbacks:</p>
      <ul>
        <li><strong>Do not perform any complex calculations as part of the callback, such as an I/O operation</strong></li>
        <li><strong>Make callback calculations CPU bound, such as accessing a concurrent value</strong></li>
      </ul>
    </blockquote>
    <p>All <a href="../metrics/primitive-metric-types.html">primitive</a> metric types, with exception to <code>Info</code> can be implemented as callbacks, like so for <code>Counter</code> and
    <code>Gauge</code>:</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">factory</span><span>
  .</span><span class="identifier">counter</span><span>(</span><span class="string-literal">&quot;counter_total&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">callback</span><span>(</span><span class="type-name">IO</span><span>(</span><span class="number-literal">1.0</span><span>))

</span><span class="identifier">factory</span><span>
  .</span><span class="identifier">gauge</span><span>(</span><span class="string-literal">&quot;gauge&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">callback</span><span>(</span><span class="type-name">IO</span><span>(</span><span class="number-literal">1.0</span><span>))</span></code></pre>
    <p><code>Histogram</code> and <code>Summary</code> metrics are slightly different as they need a special value to contain the calculated
    components of each metric type:</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">data</span><span>.</span><span class="type-name">NonEmptySeq</span><span>

</span><span class="identifier">factory</span><span>
  .</span><span class="identifier">histogram</span><span>(</span><span class="string-literal">&quot;histogram&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">buckets</span><span>(</span><span class="number-literal">0.1</span><span>, </span><span class="number-literal">0.5</span><span>)
  .</span><span class="identifier">callback</span><span>(
    </span><span class="type-name">IO</span><span>(</span><span class="type-name">Histogram</span><span>.</span><span class="type-name">Value</span><span>(</span><span class="identifier">sum</span><span> = </span><span class="number-literal">2.0</span><span>, </span><span class="identifier">bucketValues</span><span> = </span><span class="type-name">NonEmptySeq</span><span>.</span><span class="identifier">of</span><span>(</span><span class="number-literal">0.0</span><span>, </span><span class="number-literal">1.0</span><span>, </span><span class="number-literal">1.0</span><span>)))
  )</span></code></pre>
    <blockquote>⚠️️ Note that with a histogram value there must always be one more bucket value than defined when creating the metric,
    this is to provide a value for <code>+Inf</code>.</blockquote>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">factory</span><span>
  .</span><span class="identifier">summary</span><span>(</span><span class="string-literal">&quot;summary&quot;</span><span>)
  .</span><span class="identifier">ofDouble</span><span>
  .</span><span class="identifier">help</span><span>(</span><span class="string-literal">&quot;Describe what this metric does&quot;</span><span>)
  .</span><span class="identifier">callback</span><span>(
    </span><span class="type-name">IO</span><span>(</span><span class="type-name">Summary</span><span>.</span><span class="type-name">Value</span><span>(</span><span class="identifier">count</span><span> = </span><span class="number-literal">1.0</span><span>, </span><span class="identifier">sum</span><span> = </span><span class="number-literal">1.0</span><span>, </span><span class="identifier">quantiles</span><span> = </span><span class="type-name">Map</span><span>(</span><span class="number-literal">0.5</span><span> -&gt; </span><span class="number-literal">1.0</span><span>)))
  )</span></code></pre>
    <blockquote>⚠️️ Note that is you specify quantiles, max age or age buckets for the summary, you cannot register a callback. This is
    because these parameters are used when configuring a summary metric type which would be returned you, whereas the
    summary implementation may be configured differently.</blockquote>
    
    <h4 id="metric-collection" class="section">Metric Collection<a class="anchor-link right" href="#metric-collection"><i class="icofont-laika">&#xef71;</i></a></h4>
    <p>It is possible to submit multiple metrics in a single callback, this may be useful where the metrics available in some
    collection may not be known at compile time. As with callbacks in general, this should be used carefully to ensure that
    collisions at runtime aren&#39;t encountered, it is suggested that you use a custom prefix for all metrics in a given
    collection to avoid this.</p>
    <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">metricCollection</span><span>: </span><span class="type-name">IO</span><span>[</span><span class="type-name">MetricCollection</span><span>] = </span><span class="type-name">IO</span><span>(</span><span class="type-name">MetricCollection</span><span>.</span><span class="identifier">empty</span><span>)

</span><span class="identifier">factory</span><span>.</span><span class="identifier">metricCollectionCallback</span><span>(</span><span class="identifier">metricCollection</span><span>)</span></code></pre>

    <hr style="margin-top: 30px"/>
    <footer style="font-size: 90%; text-align: center">
      Prometheus4Cats is a <a href="https://permutive.com/">Permutive</a> project distributed under the <a href="https://www.apache.org/licenses/LICENSE-2.0.txt">Apache-2.0</a> license.
    </footer>

  </main>

</div>

</body>
</html>
